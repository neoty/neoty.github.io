<!DOCTYPE html><html class="theme-next mist use-motion" lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="K62j94h81lzwiKRGKbvHg3iuMCcXGXzSxdXmmedqjkg"><link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Trebuchet MS:300,300italic,400,400italic,700,700italic|Trebuchet MS:300,300italic,400,400italic,700,700italic|Trebuchet MS:300,300italic,400,400italic,700,700italic|Trebuchet MS:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=6.5.0" rel="stylesheet"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0"><link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222"><script id="hexo.configurations">var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    fastclick: true,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };</script><meta property="og:type" content="website"><meta property="og:title" content="섥"><meta property="og:url" content="https://blog.seq.kr/index.html"><meta property="og:site_name" content="섥"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="섥"><link rel="alternate" href="/atom.xml" title="섥" type="application/atom+xml"><link rel="canonical" href="https://blog.seq.kr/"><script id="page.configurations">CONFIG.page = {
    sidebar: "",
  };</script><title>섥</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129341254-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129341254-1');</script><noscript><style type="text/css"> .use-motion .motion-element, .use-motion .brand, .use-motion .menu-item, .sidebar-inner, .use-motion .post-block, .use-motion .pagination, .use-motion .comments, .use-motion .post-header, .use-motion .post-body, .use-motion .collection-title { opacity: initial; } .use-motion .logo, .use-motion .site-title, .use-motion .site-subtitle { opacity: initial; top: initial; } .use-motion { .logo-line-before i { left: initial; } .logo-line-after i { right: initial; } } </style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-right page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">섥</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Life on earth</h1></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home menu-item-active"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-timelines"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Timelines</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span> <span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.seq.kr/2018/11/25/linux/nginx-hide-server-header/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="seq.kr"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars2.githubusercontent.com/u/19975402?s=400&u=776e31ca3fc02d2000a15d8861a91ace2a7a1f15&v=4"></span> <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="섥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/11/25/linux/nginx-hide-server-header/" itemprop="url">nginx server header 감추기</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 18:23:00 / Modified: 20:33:34" itemprop="dateCreated datePublished" datetime="2018-11-25T18:23:00+09:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2018/11/25/linux/nginx-hide-server-header/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/linux/nginx-hide-server-header/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>nginx 기본 설치 시 후 response 응답의 header를 보면 <code>server</code> 항목에 nginx 버전과 심지어 os 정보까지 출력된다.<br>보안적인 측면에서 당연히 좋을 리가 없다. (해당 정보들을 수집하여 자동으로 웹서버 통계를 만드는 것으로 보이는데 통계를 위해 서비스를 하는 건 아니니..)</p><p><strong><em>ubuntu 16.04 에서 작성되었습니다.</em></strong></p><h3 id="nginx-버전과-os-정보-감추기"><a href="#nginx-버전과-os-정보-감추기" class="headerlink" title="nginx 버전과 os 정보 감추기"></a>nginx 버전과 os 정보 감추기</h3><h4 id="nginx-conf-설정"><a href="#nginx-conf-설정" class="headerlink" title="nginx.conf 설정"></a>nginx.conf 설정</h4><div class="note simple info"><p><strong>Syntax</strong>: server_tokens on | off | build | string;<br><strong>Default</strong>: server_tokens on;<br><strong>Context</strong>: http, server, location</p></div><p>http, server, location context에 적용 가능하다. 특별한일이 없다면 http context에 적용<br><figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server_tokens off;</span><br><span class="line">    생략</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight shell"><figcaption><span>nginx 재시작</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo nginx -t</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo service nginx reload</span></span><br></pre></td></tr></table></figure><h3 id="response-server-header-삭제"><a href="#response-server-header-삭제" class="headerlink" title="response server header 삭제"></a>response server header 삭제</h3><h4 id="nginx-extras-패키지-설치"><a href="#nginx-extras-패키지-설치" class="headerlink" title="nginx-extras 패키지 설치"></a>nginx-extras 패키지 설치</h4><p>위 단계는 nginx 버전 정보와 서버 os까지는 유효하지만 웹 서버 정보(nginx) 를 감추진 못한다. 구글링 결과 컴파일 단계에서 수정하는 방법 등이 존재하지만. 좀 더 쉬운 방법을 적용하였다. nginx-extras 패키지를 설치하는 방법이다.<br><strong>(처음부터 nginx-extras를 설치하면 된다)</strong><br><figure class="highlight shell"><figcaption><span>패키지 설치 후 재시작</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install nginx-extras</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo nginx -t</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo service nginx reload</span></span><br></pre></td></tr></table></figure></p><div class="note simple danger"><p>nginx-extras는 다양한 모듈을 더 지원하지만 성능이나 기능에 버그가 포함되어 있을 수도 있습니다. (사용에 신중을 기하세요.)</p></div><h4 id="nginx-conf-설정-1"><a href="#nginx-conf-설정-1" class="headerlink" title="nginx.conf 설정"></a>nginx.conf 설정</h4><div class="note simple info"><p><strong>syntax</strong>: more_set_headers [-t <code>&lt;content-type list&gt;</code>]… [-s <code>&lt;status-code list&gt;</code>]… <code>&lt;new-header&gt;</code>…<br><strong>default</strong>: no<br><strong>context</strong>: http, server, location, location if<br><strong>phase</strong>: output-header-filter</p></div><p>overwrite 방법으로 내용을 삭제한다.<br><figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    more_set_headers 'Server: ';</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight shell"><figcaption><span>nginx 재시작</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo nginx -t</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo service nginx reload</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.seq.kr/2018/11/25/nodejs/pm2-graceful-start/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="seq.kr"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars2.githubusercontent.com/u/19975402?s=400&u=776e31ca3fc02d2000a15d8861a91ace2a7a1f15&v=4"></span> <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="섥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/11/25/nodejs/pm2-graceful-start/" itemprop="url">pm2 graceful start</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 14:20:11" itemprop="dateCreated datePublished" datetime="2018-11-25T14:20:11+09:00">2018-11-25</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2018-11-26 21:39:06" itemprop="dateModified" datetime="2018-11-26T21:39:06+09:00">2018-11-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2018/11/25/nodejs/pm2-graceful-start/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/nodejs/pm2-graceful-start/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="graceful-start"><a href="#graceful-start" class="headerlink" title="graceful start"></a>graceful start</h3><div class="note info"><p>Sometimes you might need to wait for your application to have etablished connections with your DBs/caches/workers/whatever. PM2 needs to wait before considering your application as online. To do this, you need to provide –wait-ready to the CLI or provide wait_ready: true in a process file. This will make PM2 listen for that event. In your application you will need to add process.send(‘ready’); when you want your application to be considered as ready.</p><p><strong><em><a href="http://pm2.keymetrics.io/docs/usage/signals-clean-restart/#graceful-start" target="_blank" rel="noopener">pm2 graceful start</a></em></strong></p></div><p>node application 구동시 일련의 과정을 거치기 마련이다 (db, memory db pool 생성이나 기타 비동기적인 initialization 작업등) 동기 작업이라면 상관없겠지만 비동기 작업 같은 경우 콜백 등으로 구현해서 모든게 준비가 되었을떄 application 을 구동(사용 단계로 격상) 시켜야 한다.<br>pm2는 이러한 상황에 대비에 옵션으로 해당 과정을 쉽게 할 수 있게 기능을 제공한다.</p><p><strong>(원문에선 cli로 옵션을 줄수도 있지만 여기에선 ecosystem.config.js를 기준으로 설명)</strong></p><h3 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h3><h4 id="graceful-start-활성화"><a href="#graceful-start-활성화" class="headerlink" title="graceful start 활성화"></a>graceful start 활성화</h4><figure class="highlight javascript"><figcaption><span>ecosystem.config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  apps : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>            : <span class="string">'pm2-graceful-start-exmaple'</span>,</span><br><span class="line">      <span class="string">"script"</span>          : <span class="string">'bin/www'</span>,</span><br><span class="line">      <span class="string">"wait_ready"</span>      : <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"listen_timeout"</span>  : <span class="number">5000</span>,             <span class="comment">// ms 단위</span></span><br><span class="line">      env_production : &#123;</span><br><span class="line">        NODE_ENV: <span class="string">'production'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>핵심 옵션은 <code>wait_ready</code>와 <code>listen_timeout</code>이다. <code>wait_ready</code>값이 true라면 <code>listen_timeout</code>동안 대기하며 해당 시간 동안 특정한 signal 을 받지 못하면 강제로 application 이 시작(노출) 되게 된다.<br>(<code>listen_timeout</code>의 default값은 3000ms)</p><h4 id="application-시작-signal-보내기"><a href="#application-시작-signal-보내기" class="headerlink" title="application 시작 signal 보내기"></a>application 시작 signal 보내기</h4><figure class="highlight javascript"><figcaption><span>app.js (express template 이기 때문에 기본 코드 생략)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">생략</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  process.send(<span class="string">'ready'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"application published!"</span>)</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure><p>application 이 준비가 되었을 때 <code>process.send(&#39;ready&#39;)</code>코드로 pm2에 signal 을 보내면 된다. (예제는 2초 후에 앱이 구동) 비동기적인 작업등을 명시하고 모든 비동기 작업이 끝나면 콜백으로 <code>process.send(&#39;ready&#39;)</code>실행하여 안정적인 application 구동을 꾀할 수 있다.</p><h4 id="Sample-source-download"><a href="#Sample-source-download" class="headerlink" title="Sample source download"></a>Sample source download</h4><a class="btn" href="https://github.com/neoty/example-pm2-ready" target="_blank" rel="noopener"><i class="fa fa-fab fa-fw fa-github fa-lg"></i>example-pm2-ready</a></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.seq.kr/2018/11/21/nodejs/start-express-babel/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="seq.kr"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars2.githubusercontent.com/u/19975402?s=400&u=776e31ca3fc02d2000a15d8861a91ace2a7a1f15&v=4"></span> <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="섥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/11/21/nodejs/start-express-babel/" itemprop="url">express babel 적용하기</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-21 21:48:41" itemprop="dateCreated datePublished" datetime="2018-11-21T21:48:41+09:00">2018-11-21</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2018-11-26 21:30:33" itemprop="dateModified" datetime="2018-11-26T21:30:33+09:00">2018-11-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2018/11/21/nodejs/start-express-babel/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/21/nodejs/start-express-babel/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="Babel"><a href="#Babel" class="headerlink" title="Babel?"></a>Babel?</h3><div class="note info"><p>Babel is a toolchain that is mainly used to convert ECMAScript 2015+ code into a backwards compatible version of JavaScript in current and older browsers or environments. Here are the main things Babel can do for you<br><strong><em><a href="https://babeljs.io/docs/en/" target="_blank" rel="noopener">babeljs.io</a></em></strong></p></div><p><code>babel</code>은 최신 ECMA 문법을 하위 버전에 맞게 변환하여 최신 ECMA 문법을 사용할 수 있는 장점과 최신 ECMA 문법에 구애받지 않고 코드를 실행할 수 있게 해주는 도구이다.</p><h3 id="express-와-babel-사용하기"><a href="#express-와-babel-사용하기" class="headerlink" title="express 와 babel 사용하기"></a>express 와 babel 사용하기</h3><h4 id="sample-폴더-만들기"><a href="#sample-폴더-만들기" class="headerlink" title="sample 폴더 만들기"></a>sample 폴더 만들기</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir example-express-babel</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> example-express-babel</span></span><br></pre></td></tr></table></figure><h4 id="express-init"><a href="#express-init" class="headerlink" title="express init"></a>express init</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> express --view=ejs .</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br></pre></td></tr></table></figure><h4 id="소스-위치-변경"><a href="#소스-위치-변경" class="headerlink" title="소스 위치 변경"></a>소스 위치 변경</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir src</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv app.js bin public routes views ./src</span></span><br></pre></td></tr></table></figure><p>변환 대상이 되는 소스 폴더는 따로 <code>src</code> 폴더를 만들어서 옮긴다.</p><h4 id="babel-모듈-추가-amp-삭제-모듈-추가"><a href="#babel-모듈-추가-amp-삭제-모듈-추가" class="headerlink" title="babel 모듈 추가 &amp; 삭제 모듈 추가"></a>babel 모듈 추가 &amp; 삭제 모듈 추가</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install babel-cli --save-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install babel-preset-env --save-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install rimraf --save-dev</span></span><br></pre></td></tr></table></figure><h4 id="build-스크립트-추가-amp-start-command-변경"><a href="#build-스크립트-추가-amp-start-command-변경" class="headerlink" title="build 스크립트 추가 &amp; start command 변경"></a>build 스크립트 추가 &amp; start command 변경</h4><figure class="highlight bash"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vi package.json</span><br><span class="line">... 생략</span><br><span class="line"></span><br><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"node ./dist/bin/www"</span>,</span><br><span class="line">    <span class="string">"prebuild"</span>: <span class="string">"rimraf ./dist"</span>,</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"babel src --minified --out-dir ./dist --source-maps --copy-files"</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">... 생략</span><br></pre></td></tr></table></figure><p><code>prebuild</code>는 <code>npm run build</code> 실행 시 <code>build</code> 스크립트가 실행 전 실행되는 커맨드이다. (변환된 파일이 위치하게 될 <code>dist</code> 폴더를 깨끗이 삭제하는 작업)</p><h4 id="preset-설정"><a href="#preset-설정" class="headerlink" title="preset 설정"></a>preset 설정</h4><figure class="highlight shell"><figcaption><span>.babelrc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi .babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">    "presets": [</span><br><span class="line">        ["env", &#123;</span><br><span class="line">          "targets": &#123;</span><br><span class="line">            "node": "current"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>현재 설치된 <code>node</code> 버전에 맞게 변환 하도록 설정</p><h4 id="build-시작"><a href="#build-시작" class="headerlink" title="build 시작"></a>build 시작</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run build</span></span><br></pre></td></tr></table></figure><p><code>build</code> 실행</p><h4 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm run start</span><br></pre></td></tr></table></figure><h4 id="Sample-source-download"><a href="#Sample-source-download" class="headerlink" title="Sample source download"></a>Sample source download</h4><a class="btn" href="https://github.com/neoty/example-express-babel" target="_blank" rel="noopener"><i class="fa fa-fab fa-fw fa-github fa-lg"></i>example-express-babel</a><h3 id="추가"><a href="#추가" class="headerlink" title="추가"></a>추가</h3><p>ci/cd 시나리오로는</p><ol><li>개발 완료</li><li>원격 저장소 push</li><li>hook 을 이용하여 ci 도구에서 pull</li><li>ci에서 build 후</li><li>build 결과물을 배포</li><li>서버에서 재실행</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.seq.kr/2018/11/20/nodejs/dotenv-load-enviroment-file/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="seq.kr"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars2.githubusercontent.com/u/19975402?s=400&u=776e31ca3fc02d2000a15d8861a91ace2a7a1f15&v=4"></span> <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="섥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/11/20/nodejs/dotenv-load-enviroment-file/" itemprop="url">dotenv 모듈을 이용하여 동적으로 enviroment 변수 정의</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-20 21:43:21" itemprop="dateCreated datePublished" datetime="2018-11-20T21:43:21+09:00">2018-11-20</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2018-11-26 21:20:46" itemprop="dateModified" datetime="2018-11-26T21:20:46+09:00">2018-11-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2018/11/20/nodejs/dotenv-load-enviroment-file/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/20/nodejs/dotenv-load-enviroment-file/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="dotenv"><a href="#dotenv" class="headerlink" title="dotenv"></a>dotenv</h3><div class="note info"><p>Dotenv is a zero-dependency module that loads environment variables from a .env file into process.env. Storing configuration in the environment separate from code is based on The Twelve-Factor App methodology.<br><strong><em><a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener">npmjs dotenv</a></em></strong></p></div><p>nodejs dotenv 모듈을 이용하여 서버마다 최소한의 설정으로 환경에 맞는 환경변수를 사용한다.<br><strong><em>(환경 변수는 소스코드에 포함시키지 않는 게 정석이나… 관리 측면이나 공개할 소스는 아니기 때문에 상황에 맞게 사용하시면 될 듯..)</em></strong></p><h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><h4 id="실습-앱-생성"><a href="#실습-앱-생성" class="headerlink" title="실습 앱 생성"></a>실습 앱 생성</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir example-dotenv</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> example-dotenv</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm init</span></span><br><span class="line">모두 enter 입력</span><br></pre></td></tr></table></figure><h4 id="dotenv-설치"><a href="#dotenv-설치" class="headerlink" title="dotenv 설치"></a>dotenv 설치</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install dotenv</span></span><br></pre></td></tr></table></figure><h4 id="테스트용-env-파일-생성"><a href="#테스트용-env-파일-생성" class="headerlink" title="테스트용 .env 파일 생성"></a>테스트용 .env 파일 생성</h4><figure class="highlight plain"><figcaption><span>test.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test1=test1내용</span><br><span class="line">test2=test2내용</span><br></pre></td></tr></table></figure><h4 id="index-js-파일-생성"><a href="#index-js-파일-생성" class="headerlink" title="index.js 파일 생성"></a>index.js 파일 생성</h4><figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dotenv = <span class="built_in">require</span>(<span class="string">'dotenv'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config(&#123; <span class="attr">path</span>: <span class="string">'test.env'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(process.env.test1);</span><br><span class="line"><span class="built_in">console</span>.log(process.env.test2);</span><br></pre></td></tr></table></figure><h4 id="index-js-실행"><a href="#index-js-실행" class="headerlink" title="index.js 실행"></a>index.js 실행</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node index.js</span></span><br><span class="line">test1 내용</span><br><span class="line">test2 내용</span><br></pre></td></tr></table></figure><h4 id="Sample-source-download"><a href="#Sample-source-download" class="headerlink" title="Sample source download"></a>Sample source download</h4><a class="btn" href="https://github.com/neoty/example-dotenv" target="_blank" rel="noopener"><i class="fa fa-fab fa-fw fa-github fa-lg"></i>example-dotenv</a><h3 id="활용"><a href="#활용" class="headerlink" title="활용"></a>활용</h3><p>기본 골자는 <code>.env</code> 파일에 있는 내용을 그대로 <code>process.env</code>에서 사용할 수 있도록 해준다는건데, 서버별로 기본적으로 <code>NODE_ENV</code> 를 정의해놓고 서버 마다 다른 환경 설정을 기술하고 서버마다 환경에 맞는 <code>.env</code> 파일을 로드할 수 있게끔 할 수 있다.</p><h4 id="sample"><a href="#sample" class="headerlink" title="sample"></a>sample</h4><figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config(&#123; <span class="attr">path</span>: path.join(__dirname, <span class="string">`config/<span class="subst">$&#123;process.env.NODE_ENV || <span class="string">'development'</span>&#125;</span>.env`</span>) &#125;);</span><br></pre></td></tr></table></figure><p>기본 정의되어 있는 <code>NODE_ENV</code>가 정의되어 있으면 해당 <code>NODE_ENV</code> 값에 맞는 <code>.env</code> 파일을 <code>config</code> 폴더에서 찾는 모습이다. <code>NODE_ENV</code>가 없으면 기본 <code>development.env</code> 파일을 로드</p><h3 id="주의사항"><a href="#주의사항" class="headerlink" title="주의사항"></a>주의사항</h3><div class="note danger"><p><strong>What happens to environment variables that were already set?</strong><br>We will never modify any environment variables that have already been set. In particular, if there is a variable in your .env file which collides with one that already exists in your environment, then that variable will be skipped. This behavior allows you to override all .env configurations with a machine-specific environment, although it is not recommended.<br><strong><em><a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener">npmjs dotenv</a></em></strong></p></div><p><strong><code>process.env</code>아래에 이미 key가 정의되어있다면 <code>dotenv</code> 로드하여도 해당 key의 value는 overwrite 되지 않는다.(강제로 할당 하는 방법은 존재함)</strong></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.seq.kr/2018/11/19/nodejs/nodejs-mysql-pool/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="seq.kr"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars2.githubusercontent.com/u/19975402?s=400&u=776e31ca3fc02d2000a15d8861a91ace2a7a1f15&v=4"></span> <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="섥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/11/19/nodejs/nodejs-mysql-pool/" itemprop="url">mysql connection pooling</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-19 21:43:21" itemprop="dateCreated datePublished" datetime="2018-11-19T21:43:21+09:00">2018-11-19</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2018-11-25 20:40:27" itemprop="dateModified" datetime="2018-11-25T20:40:27+09:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2018/11/19/nodejs/nodejs-mysql-pool/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/19/nodejs/nodejs-mysql-pool/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="database-pooling-이-란"><a href="#database-pooling-이-란" class="headerlink" title="database pooling 이 란"></a>database pooling 이 란</h3><div class="note info"><p>In software engineering, a connection pool is a cache of database connections maintained so that the connections can be reused when future requests to the database are required. Connection pools are used to enhance the performance of executing commands on a database. (구글 <code>database pooling</code> 검색 시)</p></div><p>간단히 말해서 데이터베이스 커넥션의 캐시 개념이다 적당한 양의 pool 을 생성해놓고 application에서 database 접근이 필요할 때 connection을 처음부터 맺는 게 아니라 기존에 맺어져 있던 connection 을 하나 들고 와서 바로 사용할 수 있게 하는 개념입니다.</p><p><span style="color:#f05f70"><strong><em><a href="https://www.npmjs.com/package/mysql#pooling-connections" target="_blank" rel="noopener">mysql module pool에 대한 자세한 설명은 여기서</a></em></strong></span></p><h3 id="code-구현-기본-setup-pass"><a href="#code-구현-기본-setup-pass" class="headerlink" title="code 구현 (기본 setup pass)"></a>code 구현 (기본 setup pass)</h3><h4 id="mysql-모듈-설치"><a href="#mysql-모듈-설치" class="headerlink" title="mysql 모듈 설치"></a>mysql 모듈 설치</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install mysql</span><br></pre></td></tr></table></figure><h4 id="pool-생성"><a href="#pool-생성" class="headerlink" title="pool 생성"></a>pool 생성</h4><p>최초 1회 database에 접속하여 connection 이 정상일 경우 pool 을 생성하는 코드 pool 을 global로 할당하였지만 입맛에 맞게 수정하시면 됩니다.<br><figure class="highlight javascript"><figcaption><span>db.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mysql <span class="keyword">from</span> <span class="string">'mysql'</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 기본 정보 설정</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> connectionInfo = &#123;</span><br><span class="line">  host: process.env.DB_HOST,                            <span class="comment">// mysql 호스트</span></span><br><span class="line">  port: process.env.DB_PORT,                            <span class="comment">// mysql 포트</span></span><br><span class="line">  user: process.env.DB_USER,                            <span class="comment">// mysql access 아이디</span></span><br><span class="line">  password: process.env.DB_PASSWORD,                    <span class="comment">// mysql access 비밀번호</span></span><br><span class="line">  database: process.env.DB_DATABASE,                    <span class="comment">// 기본 접근 database 명</span></span><br><span class="line">  connectionLimit: process.env.DB_CONNECTION_LIMIT,     <span class="comment">// 최대 생성할 수 있는 pool 개수(추후 포스팅) </span></span><br><span class="line">  charset: process.env.DB_CHARSET,                      <span class="comment">// 연결 케릭터셋</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* pool 에서 실행되는 모든 쿼리들의 sql 로그를 남김</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> poolEventSetup = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  global.pool.on(<span class="string">'connection'</span>, (poolConnection) =&gt; &#123;</span><br><span class="line">    poolConnection.on(<span class="string">'enqueue'</span>, (sequence) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (sequence.constructor.name === <span class="string">'Query'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(sequence.sql);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 일반 connection 접속 체크 후 pool 생성</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> initialization = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> connectionCheck = mysql.createConnection(connectionInfo);</span><br><span class="line">  connectionCheck.connect(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    connectionCheck.end();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// connection 에러 발생</span></span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// global 할당 ex) pool.query('select * from test', (err, results) =&gt; &#123;&#125;);</span></span><br><span class="line">    global.pool = mysql.createPool(connectionInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 개발 환경 시 실행 query 로깅 활성화</span></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) poolEventSetup();</span><br><span class="line"></span><br><span class="line">    callback(<span class="literal">null</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.init = initialization;</span><br></pre></td></tr></table></figure></p><h4 id="app-js-module-load"><a href="#app-js-module-load" class="headerlink" title="app.js module load"></a>app.js module load</h4><figure class="highlight javascript"><figcaption><span>불필요 코드 생략</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'db'</span>).init(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    process.exit();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'pool 생성 완료'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="pool-생성-시"><a href="#pool-생성-시" class="headerlink" title="pool 생성 시"></a>pool 생성 시</h3><p><code>connectionLimit</code> 값을 100으로 하고 앱을 구동시 pool connection 이 곧바로 100개가 생성이 되진 않습니다.<br>초기엔 최소의 pool 개수를 유지하고 실제 여유분의 pool 이 없을 시 <code>connectionLimit</code> 개수만큼 pool connection 이 생성됩니다.<br><span style="color:#f05f70"><strong><em>(동시에 실행되는 query 가 많을 시 생성)</em></strong></span></p><p>실제로 다양한 옵션이 존재하고 mysql에 connection timeout 설정도 해주어야 진정한 pool 효과를 볼 수가 있습니다 해당 부분에 대해서 추후에 포스팅으로 다루겠습니다.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://avatars2.githubusercontent.com/u/19975402?s=400&u=776e31ca3fc02d2000a15d8861a91ace2a7a1f15&v=4" alt="seq.kr"><p class="site-author-name" itemprop="name">seq.kr</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">22</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">6</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">19</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/neoty" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i></a></span> <span class="links-of-author-item"><a href="mailto:wwwseqkr@gmail.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i></a></span></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love" id="animate"><i class="fa fa-rocket"></i></span> <span class="author" itemprop="copyrightHolder">seq.kr</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> v3.8.0</div><span class="post-meta-divider">|</span><div class="theme-info">Theme – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Mist</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script>if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-reading-progress@1.1/reading_progress.min.js"></script><script src="/js/src/utils.js?v=6.5.0"></script><script src="/js/src/motion.js?v=6.5.0"></script><script src="/js/src/bootstrap.js?v=6.5.0"></script><script id="dsq-count-scr" src="https://blog-Flo2rLxCZ0.disqus.com/count.js" async></script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('5');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="/js/src/js.cookie.js?v=6.5.0"></script><script src="/js/src/scroll-cookie.js?v=6.5.0"></script></body></html>